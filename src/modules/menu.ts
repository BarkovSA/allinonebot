import { InlineKeyboard } from "grammy";
import { BotMode } from "../types.ts";
import { setUserState } from "../middleware/state.ts";

// –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å inline-–∫–Ω–æ–ø–∫–∞–º–∏
export function getMainMenuKeyboard(): InlineKeyboard {
  const keyboard = new InlineKeyboard()
    .text("üé® –°–æ–∑–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", "menu_image_gen")
    .text("üé• –°–æ–∑–¥–∞—Ç—å –≤–∏–¥–µ–æ", "menu_video").row()
    .text("üå§Ô∏è –£–∑–Ω–∞—Ç—å –ø–æ–≥–æ–¥—É", "menu_weather")
    .text("‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è", "menu_alarm").row()
    .text("üéÆ –ò–≥—Ä—ã", "menu_games")
    .text("üçø –ß—Ç–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å?", "menu_movie").row()
    .text("üí∞ –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç", "menu_currency")
    .text("üòÇ –ê–Ω–µ–∫–¥–æ—Ç—ã", "menu_jokes").row()
    .text("üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç", "restart_bot");
  
  return keyboard;
}

// –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –º–æ–¥—É–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
export function getImageGenKeyboard(): InlineKeyboard {
  const keyboard = new InlineKeyboard()
    .text("üåå –ö–æ—Å–º–æ—Å", "image_space").row()
    .text("‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", "back_to_menu");
  
  return keyboard;
}

// –¢–µ–∫—Å—Ç –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
export function getMainMenuText(): string {
  return `=============================
  ‚ú® <b>ALLINONE BOT</b> ‚ú®
=============================

<b>üåü –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π!</b>

-----------------------------
<b>üé® –¢–í–û–†–ß–ï–°–¢–í–û</b>
-----------------------------

üé® <b>–°–æ–∑–¥–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</b>
   <i>AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å Kandinsky 3.0</i>
   ‚Üí –ü—Ä–µ–≤—Ä–∞—â–∞–π –∏–¥–µ–∏ –≤ —à–µ–¥–µ–≤—Ä—ã

üé• <b>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ</b>
   <i>–°–∫–æ—Ä–æ: AI-–∞–Ω–∏–º–∞—Ü–∏—è –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é</i>

-----------------------------
<b>üéÆ –†–ê–ó–í–õ–ï–ß–ï–ù–ò–Ø</b>
-----------------------------

üêç –ó–º–µ–π–∫–∞ —Å —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏–µ–π
üß± –ê—Ä–∫–∞–Ω–æ–∏–¥ —Å –±—É—Å—Ç–∞–º–∏
üèì –ü–∏–Ω–≥-–ø–æ–Ω–≥ –ø—Ä–æ—Ç–∏–≤ AI
ü¶ñ T-Rex Runner
üê¶ Flappy Bird
üëæ Space Invaders
üß© Tetris

-----------------------------
<b>üõ†Ô∏è –£–¢–ò–õ–ò–¢–´</b>
-----------------------------

üå§Ô∏è <b>–ü—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã</b>
   <i>–ê–∫—Ç—É–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</i>

‚è∞ <b>–£–º–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</b>
   <i>–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞–±—ã–≤–∞–π –≤–∞–∂–Ω–æ–µ</i>

üçø <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ñ–∏–ª—å–º–æ–≤</b>
   <i>–ü–æ–¥–±–æ—Ä –ø–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é</i>

üí∞ <b>–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –∏ –∫—Ä–∏–ø—Ç—ã</b>
   <i>USD, EUR, BTC, ETH, TON</i>

üòÇ <b>–ê–Ω–µ–∫–¥–æ—Ç—ã –∏ —à—É—Ç–∫–∏</b>
   <i>–ü–æ–¥–Ω–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ!</i>

-----------------------------

üíé <b>–í—ã–±–µ—Ä–∏ —Ñ—É–Ω–∫—Ü–∏—é –Ω–∏–∂–µ</b> üëá`;
}

// –¢–µ–∫—Å—Ç –¥–ª—è –º–æ–¥—É–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
export function getImageGenText(): string {
  return `=============================
  üé® <b>AI –ì–ï–ù–ï–†–ê–¢–û–†</b> üé®
=============================

‚ú® <b>–ü—Ä–µ–≤—Ä–∞—â–∞–π –º—ã—Å–ª–∏ –≤ —à–µ–¥–µ–≤—Ä—ã!</b>

-----------------------------

üìù <b>–ö–ê–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨:</b>

1Ô∏è‚É£ –û–ø–∏—à–∏ —Å–≤–æ—é –∏–¥–µ—é
2Ô∏è‚É£ –î–æ–±–∞–≤—å –¥–µ—Ç–∞–ª–∏ –∏ —Å—Ç–∏–ª—å
3Ô∏è‚É£ –ñ–¥–∏ 20-30 —Å–µ–∫—É–Ω–¥
4Ô∏è‚É£ –ü–æ–ª—É—á–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç!

-----------------------------

üí° <b>–ü–†–ò–ú–ï–†–´ –ü–†–û–ú–ü–¢–û–í:</b>

üåå "<i>–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –∫–æ—Ä–∞–±–ª—å —Å—Ä–µ–¥–∏
    —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ–π —Ç—É–º–∞–Ω–Ω–æ—Å—Ç–∏</i>"

üê± "<i>–ö–æ—Ç-–∞—Å—Ç—Ä–æ–Ω–∞–≤—Ç –Ω–∞ –õ—É–Ω–µ
    –≤ —Å–∫–∞—Ñ–∞–Ω–¥—Ä–µ</i>"

üåÜ "<i>–ù–µ–æ–Ω–æ–≤—ã–π –≥–æ—Ä–æ–¥ –±—É–¥—É—â–µ–≥–æ
    –Ω–∞ –∑–∞–∫–∞—Ç–µ, –∫–∏–±–µ—Ä–ø–∞–Ω–∫</i>"

ü¶Ñ "<i>–ï–¥–∏–Ω–æ—Ä–æ–≥ –≤ –≤–æ–ª—à–µ–±–Ω–æ–º –ª–µ—Å—É,
    –º—è–≥–∫–∏–π —Å–≤–µ—Ç</i>"

üè∞ "<i>–°—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤—ã–π –∑–∞–º–æ–∫
    –ø–∞—Ä—è—â–∏–π –≤ –æ–±–ª–∞–∫–∞—Ö</i>"

-----------------------------

üéØ <b>–°–ï–ö–†–ï–¢–´ –£–°–ü–ï–•–ê:</b>

‚úì –î–µ—Ç–∞–ª—å–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è
‚úì –•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã
‚úì –£–∫–∞–∂–∏ —Å—Ç–∏–ª—å –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
‚úì –û–ø–∏—à–∏ –æ—Å–≤–µ—â–µ–Ω–∏–µ
‚úì –î–æ–±–∞–≤—å —ç–º–æ—Ü–∏–∏

-----------------------------

‚ö° <b>–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è:</b> Kandinsky 3.0
‚è±Ô∏è <b>–í—Ä–µ–º—è:</b> ~30 —Å–µ–∫—É–Ω–¥

<b>‚úçÔ∏è –ù–∞–ø–∏—à–∏ –ø—Ä–æ–º–ø—Ç –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –≥–æ—Ç–æ–≤—ã–π ‚¨áÔ∏è</b>`;
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
export async function handleStart(ctx: any) {
  try {
    const userId = ctx.from?.id;
    if (userId) {
      setUserState(userId, BotMode.MainMenu);
    }
    
    await ctx.reply(getMainMenuText(), {
      parse_mode: "HTML",
      reply_markup: getMainMenuKeyboard(),
    });
  } catch (error) {
    console.error("Error in handleStart:", error);
    await ctx.reply("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /menu
export async function handleMenu(ctx: any) {
  try {
    const userId = ctx.from?.id;
    if (userId) {
      setUserState(userId, BotMode.MainMenu);
    }
    
    if (ctx.callbackQuery) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ (–µ—Å—Ç—å –ª–∏ —Ç–µ–∫—Å—Ç)
      try {
        await ctx.editMessageText(getMainMenuText(), {
          parse_mode: "HTML",
          reply_markup: getMainMenuKeyboard(),
        });
      } catch (_editError) {
        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, —ç—Ç–æ —Ñ–æ—Ç–æ), –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await ctx.reply(getMainMenuText(), {
          parse_mode: "HTML",
          reply_markup: getMainMenuKeyboard(),
        });
      }
      await ctx.answerCallbackQuery();
    } else {
      await ctx.reply(getMainMenuText(), {
        parse_mode: "HTML",
        reply_markup: getMainMenuKeyboard(),
      });
    }
  } catch (error) {
    console.error("Error in handleMenu:", error);
    await ctx.reply("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
export async function handleHelp(ctx: any) {
  try {
    const helpText = `=============================
     üìö <b>–°–ü–†–ê–í–ö–ê</b> üìö
=============================

-----------------------------
<b>‚ö° –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´</b>
-----------------------------

/start ‚Äî –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
/menu ‚Äî –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
/help ‚Äî –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

-----------------------------
<b>üé® –°–û–ó–î–ê–ù–ò–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô</b>
-----------------------------

<b>–®–∞–≥ 1:</b> –ñ–º–∏ "üé® –°–æ–∑–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
<b>–®–∞–≥ 2:</b> –û–ø–∏—à–∏ –∏–¥–µ—é –¥–µ—Ç–∞–ª—å–Ω–æ
<b>–®–∞–≥ 3:</b> –ñ–¥–∏ ~30 —Å–µ–∫—É–Ω–¥
<b>–®–∞–≥ 4:</b> –ù–∞—Å–ª–∞–∂–¥–∞–π—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º!

<b>üí° –°–æ–≤–µ—Ç—ã:</b>
‚Ä¢ –ü–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∏–ª–∏ (—Ä–µ–∞–ª–∏–∑–º, –∞–Ω–∏–º–µ)
‚Ä¢ –£–∫–∞–∑—ã–≤–∞–π —Ü–≤–µ—Ç–∞ –∏ –æ—Å–≤–µ—â–µ–Ω–∏–µ
‚Ä¢ –î–æ–±–∞–≤–ª—è–π —ç–º–æ—Ü–∏–∏ –∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É

-----------------------------
<b>üéÆ –ò–ì–†–´</b>
-----------------------------

üêç <b>–ó–º–µ–π–∫–∞</b> - –ø—Ä–æ—Ö–æ–¥–∏ —Å–∫–≤–æ–∑—å —Å—Ç–µ–Ω—ã
üß± <b>–ê—Ä–∫–∞–Ω–æ–∏–¥</b> - –±—É—Å—Ç—ã –∏ —Å–ø–µ—Ü—ç—Ñ—Ñ–µ–∫—Ç—ã
üèì <b>–ü–∏–Ω–≥-–ø–æ–Ω–≥</b> - —Å—Ä–∞–∑–∏—Å—å —Å AI
ü¶ñ <b>T-Rex</b> - –±–µ–≥–∏ –∏ –ø—Ä—ã–≥–∞–π
üê¶ <b>Flappy Bird</b> - –ª–µ—Ç–∞–π –º–µ–∂–¥—É —Ç—Ä—É–±
üëæ <b>Space Invaders</b> - –∑–∞—â–∏—â–∞–π –ø–ª–∞–Ω–µ—Ç—É
üß© <b>Tetris</b> - —Å–æ–±–∏—Ä–∞–π –ª–∏–Ω–∏–∏

-----------------------------
<b>üöÄ –°–ö–û–†–û</b>
-----------------------------

üé• –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ
üå§Ô∏è –ü—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã
‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
üçø –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ñ–∏–ª—å–º–æ–≤

-----------------------------

‚ùì <b>–ü—Ä–æ–±–ª–µ–º—ã?</b> –ò—Å–ø–æ–ª—å–∑—É–π /start

<i>‚ú® –ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è!</i>`;

    await ctx.reply(helpText, { parse_mode: "HTML" });
  } catch (error) {
    console.error("Error in handleHelp:", error);
    await ctx.reply("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ —Ä–µ–∂–∏–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
export async function handleImageGenCallback(ctx: any) {
  try {
    const userId = ctx.from?.id;
    if (userId) {
      setUserState(userId, BotMode.ImageGen);
    }
    
    await ctx.editMessageText(getImageGenText(), {
      parse_mode: "HTML",
      reply_markup: getImageGenKeyboard(),
    });
    await ctx.answerCallbackQuery();
  } catch (error) {
    console.error("Error in handleImageGenCallback:", error);
    await ctx.answerCallbackQuery("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞");
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –¥–ª—è –Ω–µ–≥–æ—Ç–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
export async function handleComingSoon(ctx: any, feature: string) {
  try {
    await ctx.answerCallbackQuery(`‚è≥ ${feature} —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ!`);
  } catch (error) {
    console.error("Error in handleComingSoon:", error);
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ (–æ—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞ + –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é)
export async function handleRestartBot(ctx: any) {
  try {
    const userId = ctx.from?.id;
    const chatId = ctx.chat?.id;
    
    if (!userId || !chatId) {
      await ctx.answerCallbackQuery("‚ùå –û—à–∏–±–∫–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏");
      return;
    }
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    setUserState(userId, BotMode.MainMenu);
    
    // –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–æ–æ–±—â–µ–Ω–∏–π (–≤–∫–ª—é—á–∞—è —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    const currentMessageId = ctx.callbackQuery?.message?.message_id;
    if (currentMessageId) {
      for (let i = 0; i < 20; i++) {
        try {
          await ctx.api.deleteMessage(chatId, currentMessageId - i);
        } catch {
          // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è (—Å–æ–æ–±—â–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —É–∂–µ —É–¥–∞–ª–µ–Ω–æ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ)
        }
      }
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    await ctx.api.sendMessage(chatId, getMainMenuText(), {
      parse_mode: "HTML",
      reply_markup: getMainMenuKeyboard(),
    });
    
    await ctx.answerCallbackQuery("‚úÖ –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω!");
  } catch (error) {
    console.error("Error in handleRestartBot:", error);
    await ctx.answerCallbackQuery("‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞");
  }
}
